<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HzEBOMRecordMapper">

  <resultMap  id="BaseResultMap" type="sql.pojo.epl.HzEPLManageRecord">
      <!--BOM属性-->
      <id column="PUID" jdbcType="VARCHAR" property="puid" />
      <result column="P_LINE_INDEX" jdbcType="VARCHAR" property="lineIndex" />
      <result column="P_BOM_LINE_IS_HAS" jdbcType="INTEGER" property="isHas" />
      <result column="P_BOM_LINE_IS_2Y" jdbcType="INTEGER" property="is2Y" />
      <result column="P_PARENT_UID" jdbcType="VARCHAR" property="parentUid"/>
      <result column="P_BOM_DIGIFAX_ID" jdbcType="VARCHAR" property="bomDigifaxId"/>
      <result column="P_FNA_INFO" jdbcType="VARCHAR" property="fna" />
      <result column="P_UPC" jdbcType="VARCHAR" property="pUpc" />
      <result column="P_FNA_DESC" jdbcType="VARCHAR" property="pFnaDesc" />
      <result column="P_LOU_LOA_FLAG" jdbcType="INTEGER" property="pLouaFlag"/>
      <result column="P_ORDER_ID" jdbcType="DOUBLE" property="orderId"/>
      <result column="P_REVISION" jdbcType="VARCHAR" property="revision"/>
      <result column="P_EFFECT_TIME" jdbcType="TIMESTAMP" property="effectTime"/>
      <result column="P_EPL_ID" jdbcType="DOUBLE" property="eplId"/>
      <result column="P_CREATE_TIME" jdbcType="DATE" property="pCreateTime" />
      <result column="P_UPDATE_TIME" jdbcType="DATE" property="pUpdateTime" />
      <result column="P_CREATE_NAME" jdbcType="VARCHAR" property="pCreateName" />
      <result column="P_UPDATE_NAME" jdbcType="VARCHAR" property="pUpdateName" />
      <result column="P_EBOM_STATUS" jdbcType="VARCHAR" property="status" />
      <result column="P_NUMBER" jdbcType="VARCHAR" property="number" />
      <result column="P_SORT_NUM" jdbcType="VARCHAR" property="sortNum" />
      <result column="P_COLOR_PART" jdbcType="INTEGER" property="colorPart" />
      <result column="P_VEH_NUM" jdbcType="VARCHAR" property="vehNum" />
      <result column="P_SPARE_PART" jdbcType="VARCHAR" property="sparePart"/>
      <result column="P_SPARE_PART_NUM" jdbcType="VARCHAR" property="sparePartNum"/>

      <!--衍生 EBOM 2Y层最大排序号-->
      <result column="M" jdbcType="INTEGER" property="maxLineIndexFirstNum" />

      <!--零部件属性 来自于EPL-->
      <result column="PART_ID" jdbcType="VARCHAR" property="lineID" />
      <result column="PART_OF_WHICH_DEPT" jdbcType="VARCHAR" property="pBomOfWhichDept" />
      <result column="P_BOM_LINE_PUID" jdbcType="VARCHAR" property="linePuid"/>
      <result column="P_BOM_LINE_IS_PART" jdbcType="INTEGER" property="isPart"/>
      <result column="P_BOM_ORDER_NUM" jdbcType="INTEGER" property="orderNum"/>
      <result column="P_BOM_LINE_IS_DEPT" jdbcType="INTEGER" property="isDept"/>
      <result column="PART_NAME" jdbcType="VARCHAR" property="pBomLinePartName"/>
      <result column="PART_CLASS" jdbcType="VARCHAR" property="pBomLinePartClass"/>
      <result column="PART_EN_NAME" jdbcType="VARCHAR" property="pBomLinePartEnName" />
      <result column="PART_RESOURCE" jdbcType="VARCHAR" property="pBomLinePartResource" />
      <result column="FASTENER" jdbcType="VARCHAR" property="pFastener" />
      <result column="IS_3CPART" jdbcType="INTEGER" property="p3cpartFlag" />
      <result column="IN_OUT_SIDE_FLAG" jdbcType="INTEGER" property="pInOutSideFlag" />
      <result column="UNIT" jdbcType="VARCHAR" property="pUnit" />
      <result column="PICTURE_NO" jdbcType="VARCHAR" property="pPictureNo" />
      <result column="PICTURE_SHEET" jdbcType="VARCHAR" property="pPictureSheet" />
      <result column="MATERIAL_HIGH" jdbcType="VARCHAR" property="pMaterialHigh" />
      <result column="MATERIAL1" jdbcType="VARCHAR" property="pMaterial1" />
      <result column="MATERIAL2" jdbcType="VARCHAR" property="pMaterial2" />
      <result column="MATERIAL3" jdbcType="VARCHAR" property="pMaterial3" />
      <result column="DENSITY" jdbcType="VARCHAR" property="pDensity" />
      <result column="MATERIAL_STANDARD" jdbcType="VARCHAR" property="pMaterialStandard" />
      <result column="SURFACE_TREAT" jdbcType="VARCHAR" property="pSurfaceTreat" />
      <result column="TEXTURE_COLOR_NUM" jdbcType="VARCHAR" property="pTextureColorNum" />
      <result column="MANU_PROCESS" jdbcType="VARCHAR" property="pManuProcess" />
      <result column="SYMMETRY" jdbcType="VARCHAR" property="pSymmetry" />
      <result column="IMPORTANCE" jdbcType="VARCHAR" property="pImportance" />
      <result column="REGULATION_FLAG" jdbcType="INTEGER" property="pRegulationFlag" />
      <result column="BWG_BOX_PART" jdbcType="VARCHAR" property="pBwgBoxPart" />
      <result column="DEVELOP_TYPE" jdbcType="VARCHAR" property="pDevelopType" />
      <result column="DATA_VERSION" jdbcType="VARCHAR" property="pDataVersion" />
      <result column="TARGET_WEIGHT" jdbcType="VARCHAR" property="pTargetWeight" />
      <result column="FEATURE_WEIGHT" jdbcType="VARCHAR" property="pFeatureWeight" />
      <result column="ACTUAL_WEIGHT" jdbcType="VARCHAR" property="pActualWeight" />
      <result column="FASTENER_STANDARD" jdbcType="VARCHAR" property="pFastenerStandard" />
      <result column="FASTENER_LEVEL" jdbcType="VARCHAR" property="pFastenerLevel" />
      <result column="TORQUE" jdbcType="VARCHAR" property="pTorque" />
      <result column="DUTY_ENGINEER" jdbcType="VARCHAR" property="pDutyEngineer" />
      <result column="SUPPLY" jdbcType="VARCHAR" property="pSupply" />
      <result column="SUPPLY_CODE" jdbcType="VARCHAR" property="pSupplyCode" />
      <result column="REMARK" jdbcType="VARCHAR" property="pRemark" />
      <result column="REGULATION_CODE" jdbcType="VARCHAR" property="pRegulationCode" />
      <result column="BUY_ENGINEER" jdbcType="INTEGER" property="pBuyEngineer" />
  </resultMap>


    <sql id="EBOM_COLUMN">
    PUID, P_PARENT_UID, P_BOM_DIGIFAX_ID, P_LINE_INDEX, P_BOM_LINE_IS_HAS, P_BOM_LINE_PUID,
    P_BOM_LINE_ID, P_BOM_LINE_IS_2Y, P_BOM_LINE_IS_PART, P_BOM_ORDER_NUM, P_BOM_LINE_IS_DEPT,
    P_BOM_OF_WHICH_DEPT, P_BOM_LINE_PART_NAME, P_BOM_LINE_PART_CLASS, P_BOM_LINE_PART_EN_NAME,
    P_BOM_LINE_PART_RESOURCE,P_SPARE_PART,P_SPARE_PART_NUM
  </sql>

    <!--基本的BOM属性-->
    <sql id="BASE_BOM_COLUMN">
    t.PUID, t.P_PARENT_UID,t.P_BOM_DIGIFAX_ID, t.P_LINE_INDEX, t.P_BOM_LINE_IS_HAS,
    t.P_BOM_LINE_ID, t.P_BOM_LINE_IS_2Y,
    t.P_FNA_INFO, t.P_EBOM_STATUS, t.P_CREATE_TIME, t.P_UPDATE_TIME,
    t.P_UPC, t.P_FNA_DESC, t.P_CREATE_NAME,
    t.P_UPDATE_NAME,t.P_NUMBER, t.P_ORDER_ID, t.P_LOU_LOA_FLAG, t.P_SORT_NUM, t.P_COLOR_PART, t.P_REVISION,
    t.P_EFFECT_TIME, t.P_EPL_ID,t.P_VEH_NUM,t.P_SPARE_PART,t.P_SPARE_PART_NUM
  </sql>

    <!--BOM的零部件属性 放到EPL中维护 但是需要在EBOM中显示出来-->
    <sql id="EPL_COLUMN">
    t10.PART_ID, t10.PART_OF_WHICH_DEPT, t10.PART_NAME, t10.PART_CLASS, t10.PART_EN_NAME,
    t10.PART_RESOURCE, t10.FASTENER, t10.IS_3CPART, t10.IN_OUT_SIDE_FLAG,
    t10.UNIT, t10.PICTURE_NO, t10.PICTURE_SHEET, t10.MATERIAL_HIGH, t10.MATERIAL1,
    t10.MATERIAL2, t10.MATERIAL3, t10.DENSITY, t10.MATERIAL_STANDARD, t10.SURFACE_TREAT, t10.TEXTURE_COLOR_NUM,
    t10.MANU_PROCESS, t10.SYMMETRY, t10.IMPORTANCE, t10.REGULATION_FLAG, t10.BWG_BOX_PART, t10.DEVELOP_TYPE,
    t10.DATA_VERSION, t10.TARGET_WEIGHT, t10.FEATURE_WEIGHT, t10.ACTUAL_WEIGHT, t10.FASTENER_STANDARD, t10.FASTENER_LEVEL,
    t10.TORQUE, t10.DUTY_ENGINEER, t10.SUPPLY, t10.SUPPLY_CODE, t10.REMARK, t10.REGULATION_CODE, t10.BUY_ENGINEER
  </sql>




        <sql id="BASE_BOM_INSERT">
        PUID, P_PARENT_UID,P_BOM_DIGIFAX_ID, P_LINE_INDEX, P_BOM_LINE_IS_HAS,
        P_BOM_LINE_ID, P_BOM_LINE_IS_2Y,
        P_FNA_INFO, P_CREATE_TIME, P_UPDATE_TIME,
        P_UPC, P_FNA_DESC, P_CREATE_NAME,
        P_UPDATE_NAME,P_NUMBER, P_ORDER_ID,P_EBOM_STATUS,
        P_SORT_NUM, P_COLOR_PART, P_REVISION,
        P_EFFECT_TIME, P_EPL_ID,P_VEH_NUM,P_SPARE_PART,P_SPARE_PART_NUM
      </sql>

        <sql id="BASE_BOM_IMPORT">
        PUID, P_PARENT_UID,P_BOM_DIGIFAX_ID, P_LINE_INDEX, P_BOM_LINE_IS_HAS,
        P_BOM_LINE_ID, P_BOM_LINE_IS_2Y,
        P_FNA_INFO, P_EBOM_STATUS, P_CREATE_TIME, P_UPDATE_TIME,
        P_UPC, P_FNA_DESC, P_CREATE_NAME,
        P_UPDATE_NAME,P_NUMBER,
        P_SORT_NUM, P_COLOR_PART,P_EPL_ID,P_SPARE_PART,P_SPARE_PART_NUM
      </sql>

    <sql id="BASE_BOM_INSERT_VALUES">
        #{puid,jdbcType=VARCHAR},#{parentUid,jdbcType=VARCHAR},#{bomDigifaxId,jdbcType=VARCHAR},
        #{lineIndex,jdbcType=VARCHAR},#{isHas,jdbcType=INTEGER},
        #{lineID,jdbcType=VARCHAR},
        #{is2Y,jdbcType=INTEGER},
        #{fna,jdbcType=VARCHAR},
        sysdate,sysdate,
        #{pUpc,jdbcType=VARCHAR}, #{pFnaDesc,jdbcType=VARCHAR}, #{pCreateName,jdbcType=VARCHAR},
        #{pUpdateName,jdbcType=VARCHAR},
        #{number,jdbcType=VARCHAR},
        #{orderId,jdbcType=DOUBLE},#{status,jdbcType=INTEGER},
        #{sortNum,jdbcType=VARCHAR},
        #{colorPart,jdbcType=INTEGER},
        #{revision,jdbcType=VARCHAR},
        #{effectTime,jdbcType=VARCHAR},
        #{eplId,jdbcType=DOUBLE},
        #{vehNum,jdbcType=VARCHAR},
        #{sparePart,jdbcType=VARCHAR},
        #{sparePartNum,jdbcType=VARCHAR}
  </sql>


    <sql id="BASE_BOM_INSERT_VALUES_BATCH">
        #{item.puid,jdbcType=VARCHAR},#{item.parentUid,jdbcType=VARCHAR},#{item.bomDigifaxId,jdbcType=VARCHAR},
        #{item.lineIndex,jdbcType=VARCHAR},#{item.isHas,jdbcType=INTEGER},
        #{item.lineID,jdbcType=VARCHAR},
        #{item.is2Y,jdbcType=INTEGER},
        #{item.fna,jdbcType=VARCHAR},sysdate,sysdate,
        #{item.pUpc,jdbcType=VARCHAR}, #{item.pFnaDesc,jdbcType=VARCHAR}, #{item.pCreateName,jdbcType=VARCHAR},
        #{item.pUpdateName,jdbcType=VARCHAR},
        #{item.number,jdbcType=VARCHAR},
        #{item.orderId,jdbcType=DOUBLE},#{item.status,jdbcType=INTEGER},
        #{item.sortNum,jdbcType=VARCHAR},
        #{item.colorPart,jdbcType=INTEGER},
        #{item.revision,jdbcType=VARCHAR},
        #{item.effectTime,jdbcType=VARCHAR},
        #{item.eplId,jdbcType=DOUBLE},
        #{item.vehNum,jdbcType=VARCHAR},
        #{item.sparePart,jdbcType=VARCHAR},
        #{item.sparePartNum,jdbcType=VARCHAR}
  </sql>

    <sql id="BASE_BOM_IMPORT_VALUES_BATCH">
        #{item.puid,jdbcType=VARCHAR},#{item.parentUid,jdbcType=VARCHAR},#{item.bomDigifaxId,jdbcType=VARCHAR},
        #{item.lineIndex,jdbcType=VARCHAR},#{item.isHas,jdbcType=INTEGER},
        #{item.lineId,jdbcType=VARCHAR},
        #{item.is2Y,jdbcType=INTEGER},
        #{item.pFnaInfo,jdbcType=VARCHAR},2,
        sysdate,sysdate,
         #{item.pUpc,jdbcType=VARCHAR}, #{item.pFnaDesc,jdbcType=VARCHAR}, #{item.pCreateName,jdbcType=VARCHAR},
        #{item.pUpdateName,jdbcType=VARCHAR},
        #{item.number,jdbcType=VARCHAR},
        #{item.sortNum,jdbcType=VARCHAR},
        #{item.colorPart,jdbcType=INTEGER},
        #{item.eplId,jdbcType=DOUBLE},
        #{item.sparePart,jdbcType=VARCHAR},
        #{item.sparePartNum,jdbcType=VARCHAR}
  </sql>

    <!--分页查询 EBOM全信息-->
    <select id="HzEbomRecordDAOImpl_getHzEbomList" resultMap="BaseResultMap" parameterType="java.util.HashMap">
        select * FROM
        (SELECT u.*,rownum as rn from
        (SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid=#{projectId,jdbcType=VARCHAR}))
            <if test="lineIndex != null and lineIndex!=''">
                and LENGTH(TRANSLATE(t.P_LINE_INDEX,',0123456789','.'))=#{lineIndex,jdbcType=VARCHAR}
            </if>
            <if test="isHas != null and isHas==0">
                and t.P_BOM_LINE_IS_HAS = 0
            </if>
            <if test="isHas != null and isHas==1">
                and t.P_BOM_LINE_IS_HAS = 1
            </if>
            <if test="lineId != null and lineId!=''" >
                and t10.PART_ID like CONCAT(CONCAT('%',#{lineId,jdbcType=VARCHAR}),'%')
            </if>
            <if test="pBomOfWhichDept != null and  pBomOfWhichDept!='' " >
                and t10.PART_OF_WHICH_DEPT like CONCAT(CONCAT('%',#{pBomOfWhichDept,jdbcType=VARCHAR}),'%')
            </if>
            <if test="pBomLinePartClass != null and pBomLinePartClass!=''">
                and t10.PART_CLASS = #{pBomLinePartClass,jdbcType=VARCHAR}
            </if>
            <if test="pBomLinePartResource != null and pBomLinePartResource!=''">
                and t10.PART_RESOURCE = #{pBomLinePartResource,jdbcType=VARCHAR}
            </if>
            and t.P_EBOM_STATUS <![CDATA[ <> ]]>0  order by CAST(t.P_SORT_NUM as FLOAT))u
        </where>
        WHERE ROWNUM &lt;=#{limit,jdbcType=INTEGER}) where rn &gt;#{offset,jdbcType=INTEGER}
    </select>


  <!--查询 EBOM总数-->
  <select id="HzEbomRecordDAOImpl_findTotalCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">
      SELECT count(*)
      from HZ_BOM_LINE_RECORD t
      left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
      where t.p_bom_digifax_id=(
      select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
      select t2.puid from Hz_project_libs t2
      <where>
      t2.puid=#{projectId,jdbcType=VARCHAR}))
      <if test="lineIndex != null and lineIndex!=''">
          and LENGTH(TRANSLATE(t.P_LINE_INDEX,',0123456789','.'))=#{lineIndex,jdbcType=VARCHAR}
      </if>
      <if test="isHas != null and isHas==0">
          and t.P_BOM_LINE_IS_HAS = 0
      </if>
      <if test="isHas != null and isHas==1">
          and t.P_BOM_LINE_IS_HAS = 1
      </if>
      <if test="lineId != null and lineId!=''" >
          and t10.PART_ID like CONCAT(CONCAT('%',#{lineId,jdbcType=VARCHAR}),'%')
      </if>
      <if test="pBomOfWhichDept != null and  pBomOfWhichDept!='' " >
          and t10.PART_OF_WHICH_DEPT like CONCAT(CONCAT('%',#{pBomOfWhichDept,jdbcType=VARCHAR}),'%')
      </if>
      <if test="pBomLinePartClass != null and pBomLinePartClass!=''">
          and t10.PART_CLASS = #{pBomLinePartClass,jdbcType=VARCHAR}
      </if>
      <if test="pBomLinePartResource != null and pBomLinePartResource!=''">
          and t10.PART_RESOURCE = #{pBomLinePartResource,jdbcType=VARCHAR}
      </if>
      and t.P_EBOM_STATUS <![CDATA[ <> ]]>0
      </where>
  </select>


  <!--查询bomLine的子bom 信息-->
  <select id="HzEbomRecordDAOImpl_getHzBomLineChildren"  resultMap="BaseResultMap" parameterType="java.util.HashMap">
    SELECT
      <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
      from HZ_BOM_LINE_RECORD t
      left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
    where t.p_bom_digifax_id=(
    select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
    select t2.puid from Hz_project_libs t2
    <where>
      t2.puid=#{projectId,jdbcType=VARCHAR}))
    </where>
      start with t.puid = #{puid,jdbcType=VARCHAR} and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
      <if test="colorPart != null">
          and t.P_COLOR_PART = #{colorPart,jdbcType=INTEGER}
      </if>
      connect by prior t.puid = t.p_parent_uid  and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
      <if test="colorPart != null">
          and t.P_COLOR_PART = #{colorPart,jdbcType=INTEGER}
      </if>
      order by CAST(t.P_SORT_NUM as FLOAT)
  </select>

    <!--查询 一条EBOM全信息-->
    <select id="HzEbomRecordDAOImpl_findEbomById" resultMap="BaseResultMap" parameterType="java.util.HashMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
          #{projectId,jdbcType=VARCHAR}))
          and t.puid = #{puid,jdbcType=VARCHAR}
          and t.P_EBOM_STATUS <![CDATA[ <> ]]>0
    </select>


    <!--查询零件是否存在子层信息-->
    <select id="HzEbomRecordDAOImpl_findIsHasByPuid" resultType="java.lang.Integer" parameterType="java.util.HashMap">
        SELECT t1.P_BOM_LINE_IS_HAS from HZ_BOM_LINE_RECORD t1
        where P_BOM_DIGIFAX_ID =(
        select t2.puid from Hz_Bom_Main_Record t2
        where
        t2.p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR}
        ) and t1.P_EBOM_STATUS <![CDATA[ <> ]]> 0 and
        t1.PUID=#{puid,jdbcType=VARCHAR}
    </select>

    <!--查询选中零件父层信息-->
    <select id="HzEbomRecordDAOImpl_getHzBomLineParent"  resultMap="BaseResultMap" parameterType="java.util.HashMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid=#{projectId,jdbcType=VARCHAR}))
        </where>
        start with t10.PART_ID = #{lineId,jdbcType=VARCHAR} and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
        connect by prior t.puid = t.p_parent_uid  and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
        order by CAST(t.P_SORT_NUM as FLOAT)
    </select>



    <!--根据零件号查询bom-->
    <select id="HzEbomRecordDAOImpl_findEbom" resultMap="BaseResultMap" parameterType="java.util.HashMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid=#{projectId,jdbcType=VARCHAR}))
            <if test="puid != null and puid!=''">
                and t.puid = #{puid,jdbcType=VARCHAR}
            </if>
            <if test="lineID != null and lineID!=''">
                and t10.PART_ID = #{lineID,jdbcType=VARCHAR}
            </if>
            <if test="parentId != null and parentId!=''">
                and t.P_PARENT_UID = #{parentId,jdbcType=VARCHAR}
            </if>
            and t.P_EBOM_STATUS <![CDATA[ <> ]]>0
            order by CAST(t.P_SORT_NUM as FLOAT)
        </where>
    </select>


    <!--找出大于当前排序号的最小排序号-->
    <select id="HzEbomRecordDAOImpl_findMinOrderNumWhichGreaterThanThisOrderNum" parameterType="java.util.HashMap" resultType="java.lang.String">
        SELECT * FROM (
        SELECT P_SORT_NUM  FROM HZ_BOM_LINE_RECORD
        where p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
        t2.puid=#{projectId,jdbcType=VARCHAR}))
        </where>
        and P_EBOM_STATUS <![CDATA[ <> ]]>0
        and  CAST(P_SORT_NUM as FLOAT) &gt;#{sortNum,jdbcType=DOUBLE}
        ORDER BY  CAST(P_SORT_NUM as FLOAT))WHERE rownum =1
    </select>


    <insert id="HzEbomRecordDAOImpl_insert" parameterType="sql.pojo.epl.HzEPLManageRecord">
        insert into ${tableName}
        (
        <include refid="BASE_BOM_INSERT"/>
        )
        values
        (
        <include refid="BASE_BOM_INSERT_VALUES"/>
      )

    </insert>

    <!--更新-->
    <update id="HzEbomRecordDAOImpl_update" parameterType="sql.pojo.epl.HzEPLManageRecord">
        update HZ_BOM_LINE_RECORD
        <set>
              P_UPDATE_TIME =sysdate,
              P_EBOM_STATUS = 2,
            <if test="fna != null">
                P_FNA_INFO = #{fna,jdbcType=VARCHAR},
            </if>
            <if test="pInOutSideFlag != null">
                P_IN_OUT_SIDE_FLAG = #{pInOutSideFlag,jdbcType=INTEGER},
            </if>
            <if test="pUpc != null">
                P_UPC = #{pUpc,jdbcType=VARCHAR},
            </if>
            <if test="pFnaDesc != null">
                P_FNA_DESC = #{pFnaDesc,jdbcType=VARCHAR},
            </if>
            <if test="pUpdateName != null">
                P_UPDATE_NAME = #{pUpdateName,jdbcType=VARCHAR},
            </if>
            <if test="number != null">
                P_NUMBER = #{number,jdbcType=VARCHAR},
            </if>
            <if test="colorPart != null">
                P_COLOR_PART = #{colorPart,jdbcType=INTEGER},
            </if>
            <if test="vehNum != null">
                P_VEH_NUM = #{vehNum,jdbcType=VARCHAR},
            </if>
            <if test="sparePart != null">
                P_SPARE_PART = #{sparePart,jdbcType=VARCHAR},
            </if>
            <if test="sparePartNum != null">
                P_SPARE_PART_NUM = #{sparePartNum,jdbcType=VARCHAR}
            </if>
        </set>
        where
        P_BOM_DIGIFAX_ID = (select puid from Hz_Bom_Main_Record  where p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR})
        and
        PUID = #{puid,jdbcType=VARCHAR}
    </update>

    <!--导入excel文件到EBOM写的批量插入-->
    <insert id="HzEbomRecordDAOImpl_importList" parameterType="java.util.List">
        insert into HZ_BOM_LINE_RECORD
        (<include refid="BASE_BOM_IMPORT"/>)
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            select <include refid="BASE_BOM_IMPORT_VALUES_BATCH"/>
            from DUAL
        </foreach>
    </insert>

    <!-- 更新EBOM信息 根据主键更新-->
    <update id="HzEbomRecordDAOImpl_updateListByPuids" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
            update Hz_Bom_Line_Record
            <set>
                P_UPDATE_TIME =sysdate,
                <if test="item.status != null">
                    P_EBOM_STATUS = #{item.status,jdbcType=VARCHAR},
                </if>
                <if test="item.fna != null">
                    P_FNA_INFO = #{item.fna,jdbcType=VARCHAR},
                </if>
                <if test="item.pInOutSideFlag != null">
                    P_IN_OUT_SIDE_FLAG = #{item.pInOutSideFlag,jdbcType=INTEGER},
                </if>
                <if test="item.pLouaFlag != null">
                    P_LOU_LOA_FLAG = #{item.pLouaFlag,jdbcType=INTEGER},
                </if>
                <if test="item.pUpc != null">
                    P_UPC = #{item.pUpc,jdbcType=VARCHAR},
                </if>
                <if test="item.pFnaDesc != null">
                    P_FNA_DESC = #{item.pFnaDesc,jdbcType=VARCHAR},
                </if>
                <if test="item.pUpdateName != null">
                    P_UPDATE_NAME = #{item.pUpdateName,jdbcType=VARCHAR},
                </if>
                <if test="item.number != null">
                    P_NUMBER = #{item.number,jdbcType=VARCHAR},
                </if>
                <if test="item.colorPart != null">
                    P_COLOR_PART = #{item.colorPart,jdbcType=INTEGER},
                </if>
                <if test="item.orderId != null">
                    P_ORDER_ID = #{item.orderId,jdbcType=DOUBLE},
                </if>
                <if test="item.effectTime != null">
                    P_EFFECT_TIME = #{item.effectTime,jdbcType=TIMESTAMP},
                </if>
                <if test="item.revision != null">
                    P_REVISION = #{item.revision,jdbcType=VARCHAR},
                </if>
                <if test="item.eplId != null">
                    P_EPL_ID = #{item.eplId,jdbcType=DOUBLE},
                </if>
                <if test="item.lineIndex != null">
                    P_LINE_INDEX = #{item.lineIndex,jdbcType=VARCHAR},
                </if>
                <if test="item.parentUid != null">
                    P_PARENT_UID = #{item.parentUid,jdbcType=VARCHAR},
                </if>
                <if test="item.sortNum != null">
                    P_SORT_NUM = #{item.sortNum,jdbcType=VARCHAR},
                </if>
                <if test="item.isHas != null">
                    P_BOM_LINE_IS_HAS = #{item.isHas,jdbcType=INTEGER},
                </if>
                <if test="item.vehNum != null">
                    P_VEH_NUM = #{item.vehNum,jdbcType=VARCHAR},
                </if>
                <if test="item.sparePart != null">
                    P_SPARE_PART = #{item.sparePart,jdbcType=VARCHAR},
                </if>
                <if test="item.sparePartNum != null">
                    P_SPARE_PART_NUM = #{item.sparePartNum,jdbcType=VARCHAR}
                </if>
            </set>
            where puid = #{item.puid,jdbcType=VARCHAR}
            and P_EBOM_STATUS <![CDATA[ <> ]]>0
        </foreach>
    </update>


    <!-- 更新EBOM信息-->
    <update id="HzEbomRecordDAOImpl_updateListByEplId" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
            update Hz_Bom_Line_Record
            <set>
                P_UPDATE_TIME =sysdate,
                <if test="item.status != null">
                    P_EBOM_STATUS = #{item.status,jdbcType=VARCHAR},
                </if>
                <if test="item.fna != null">
                    P_FNA_INFO = #{item.fna,jdbcType=VARCHAR},
                </if>
                <if test="item.pUpc != null">
                    P_UPC = #{item.pUpc,jdbcType=VARCHAR},
                </if>
                <if test="item.pFnaDesc != null">
                    P_FNA_DESC = #{item.pFnaDesc,jdbcType=VARCHAR},
                </if>
                <if test="item.pUpdateName != null">
                    P_UPDATE_NAME = #{item.pUpdateName,jdbcType=VARCHAR},
                </if>
                <if test="item.number != null">
                    P_NUMBER = #{item.number,jdbcType=VARCHAR},
                </if>
                <if test="item.orderId != null">
                    P_ORDER_ID = #{item.orderId,jdbcType=DOUBLE},
                </if>
                <if test="item.effectTime != null">
                    P_EFFECT_TIME = #{item.effectTime,jdbcType=TIMESTAMP},
                </if>
                <if test="item.revision != null">
                    P_REVISION = #{item.revision,jdbcType=VARCHAR},
                </if>
                <if test="item.vehNum != null">
                    P_VEH_NUM = #{item.vehNum,jdbcType=VARCHAR},
                </if>
                <if test="item.sparePart != null">
                    P_SPARE_PART = #{item.sparePart,jdbcType=VARCHAR},
                </if>
                <if test="item.sparePartNum != null">
                    P_SPARE_PART_NUM = #{item.sparePartNum,jdbcType=VARCHAR}
                </if>
            </set>
            where P_EPL_ID = #{item.eplId,jdbcType=VARCHAR}
            and P_BOM_DIGIFAX_ID=#{item.bomDigifaxId,jdbcType=VARCHAR}
            and P_EBOM_STATUS <![CDATA[ <> ]]>0
        </foreach>
    </update>





    <!-- 更新EBOM信息-->
    <update id="HzEbomRecordDAOImpl_updateEBOMListByEplId" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
            update Hz_Bom_Line_Record
            <set>
                P_UPDATE_TIME =sysdate,
                <if test="item.status != null">
                    P_EBOM_STATUS = #{item.status,jdbcType=VARCHAR},
                </if>
                    P_FNA_INFO = #{item.fna,jdbcType=VARCHAR},
                    P_UPC = #{item.pUpc,jdbcType=VARCHAR},
                    P_FNA_DESC = #{item.pFnaDesc,jdbcType=VARCHAR},
                    P_UPDATE_NAME = #{item.pUpdateName,jdbcType=VARCHAR},
                    P_NUMBER = #{item.number,jdbcType=VARCHAR},
                <if test="item.orderId != null">
                    P_ORDER_ID = #{item.orderId,jdbcType=DOUBLE},
                </if>
                <if test="item.effectTime != null">
                    P_EFFECT_TIME = #{item.effectTime,jdbcType=TIMESTAMP},
                </if>
                <if test="item.revision != null">
                    P_REVISION = #{item.revision,jdbcType=VARCHAR},
                </if>
                    P_VEH_NUM = #{item.vehNum,jdbcType=VARCHAR},
                    P_SPARE_PART = #{item.sparePart,jdbcType=VARCHAR},
                    P_SPARE_PART_NUM = #{item.sparePartNum,jdbcType=VARCHAR}
            </set>
            where P_EPL_ID = #{item.eplId,jdbcType=VARCHAR}
            and P_BOM_DIGIFAX_ID=#{item.bomDigifaxId,jdbcType=VARCHAR}
            and P_EBOM_STATUS <![CDATA[ <> ]]>0
        </foreach>
    </update>


    <select id="HzEbomRecordDAOImpl_lineIndexRepeat" parameterType="java.util.HashMap" resultType="java.lang.Integer">
        select count(*) from HZ_BOM_LINE_RECORD t1
        where t1.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid=#{projectId,jdbcType=VARCHAR}))
            and P_LINE_INDEX = #{lineIndex,jdbcType=VARCHAR}
            and t1.P_EBOM_STATUS <![CDATA[ <> ]]>0
        </where>
    </select>


    <select id="HzEbomRecordDAOImpl_getAll2YBomRecord" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        select <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid=#{projectId,jdbcType=VARCHAR}))
            <if test="colorPart != null">
                and t.P_COLOR_PART = #{colorPart,jdbcType=INTEGER}
            </if>
            and t.P_BOM_LINE_IS_2Y=1
        </where>
    </select>

    <!--&lt;!&ndash;获取除变形外的相同的零件号&ndash;&gt;-->
    <!--<select id="HzEbomRecordDAOImpl_getSameNameLineId" parameterType="java.util.HashMap" resultMap="BaseResultMap">-->
        <!--select * from HZ_BOM_LINE_RECORD t1-->
        <!--where t1.p_bom_digifax_id=(-->
        <!--select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(-->
        <!--select t2.puid from Hz_project_libs t2-->
        <!--<where>-->
            <!--t2.puid=#{projectId,jdbcType=VARCHAR}))-->
            <!--<if test="lineId != null and lineId!=''" >-->
                <!--and t1.P_BOM_LINE_ID like CONCAT(CONCAT('%',#{lineId,jdbcType=VARCHAR}),'%')-->
            <!--</if>-->
        <!--</where>-->
    <!--</select>-->

    <!--&lt;!&ndash;查询油漆车身总成和白车身总成&ndash;&gt;-->
    <!--<select id="HzEbomRecordDAOImpl_getPaintAndWhiteBody" parameterType="java.util.HashMap" resultMap="BaseResultMap">-->
        <!--SELECT t1.* from HZ_BOM_LINE_RECORD t1-->
        <!--where t1.p_bom_digifax_id=(-->
        <!--select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(-->
        <!--select t2.puid from Hz_project_libs t2-->
        <!--<where>-->
            <!--t2.puid=#{projectId,jdbcType=VARCHAR}))-->
            <!--and (t1.P_BOM_LINE_PART_NAME like '白车身总成%'-->
            <!--or t1.P_BOM_LINE_PART_NAME like '油漆车身总成%')-->

            <!--and (t1.P_BOM_LINE_PART_RESOURCE ='采购件'or-->
            <!--t1.P_BOM_LINE_PART_RESOURCE ='自制总成' or-->
            <!--t1.P_BOM_LINE_PART_RESOURCE ='自制单件'or-->
            <!--t1.P_BOM_LINE_PART_RESOURCE ='自用标准件'or-->
            <!--t1.P_BOM_LINE_PART_RESOURCE ='自用非标件'or-->
            <!--t1.P_BOM_LINE_PART_RESOURCE ='虚拟总成')-->
        <!--</where>-->
        <!--start with t1.puid = #{puid,jdbcType=VARCHAR} and t1.P_EBOM_STATUS<![CDATA[ <> ]]>0-->
        <!--connect by prior t1.puid = t1.p_parent_uid  and t1.P_EBOM_STATUS<![CDATA[ <> ]]>0-->
        <!--order by CAST(t1.P_SORT_NUM as FLOAT)-->
    <!--</select>-->



    <!--分页获取EBOM结构树-->
    <select id="HzEbomRecordDAOImpl_getHzEbomTreeByPage" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        <if test="puids != null and puids.size()>0">
            select * from(
            select u.*,rownum as rn from (
            <foreach collection="puids" index="index" item="item"  separator="union all">
                select * from
                (
                select <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
                from HZ_BOM_LINE_RECORD t
                left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
                where t.p_bom_digifax_id=(
                select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(#{projectId,jdbcType=VARCHAR}))
                start with t.puid = #{puids[${index}]}
                and t.P_EBOM_STATUS <![CDATA[ <> ]]>0
                connect by nocycle prior t.puid = t.p_parent_uid

                and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
                order by CAST(t.P_SORT_NUM as FLOAT)
                )
            </foreach>
            ) u
            where  ROWNUM &lt;=#{limit,jdbcType=INTEGER})
            where  rn &gt;#{offset,jdbcType=INTEGER}
        </if>
    </select>


    <!--分页获取EBOM结构树总数-->
    <select id="HzEbomRecordDAOImpl_getHzEbomTreeTotalCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
        <if test="puids != null and puids.size()>0">
            select sum(c) from
            (
            <foreach collection="puids" index="index" item="item" separator="union all">
                select count(*) c
                from HZ_BOM_LINE_RECORD t
                where t.p_bom_digifax_id=(
                select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
                select t2.puid from Hz_project_libs t2
                <where>
                    t2.puid = #{projectId,jdbcType=VARCHAR}))
                </where>

                start with t.puid = #{puids[${index}]}

                and t.P_EBOM_STATUS <![CDATA[ <> ]]>0

                connect by nocycle prior t.puid = t.p_parent_uid

                and t.P_EBOM_STATUS<![CDATA[ <> ]]>0
            </foreach>
            )
        </if>

    </select>



    <!--批量插入EBOM数据-->
    <insert id="HzEbomRecordDAOImpl_insertList" parameterType="java.util.HashMap">
        insert into ${tableName}
        (<include refid="BASE_BOM_INSERT"/>)
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            select <include refid="BASE_BOM_INSERT_VALUES_BATCH"/>
            from DUAL
        </foreach>
    </insert>



    <!--批量删除 逻辑删 EBOM-->
    <update id="HzEbomRecordDAOImpl_deleteList" parameterType="java.util.HashMap">
        <foreach collection="puids" item="item" index="index" open="begin" close=";end;" separator=";">
            update HZ_BOM_LINE_RECORD
            <set>
                P_UPDATE_TIME =sysdate,
                P_EBOM_STATUS = 4
            </set>
            where PUID = #{puids[${index}]}
        </foreach>
    </update>


    <!--批量删除 物理删 EBOM-->
    <delete id="HzEbomRecordDAOImpl_deleteByPuids" parameterType="java.util.HashMap">
        delete ${tableName} where puid in
        <foreach collection="puids" index="index" item="item"  open="(" separator="," close=")">
            #{puids[${index}]}
        </foreach>
    </delete>


    <!--批量查询数据-->
    <select id="HzEbomRecordDAOImpl_getEbomRecordsByPuids" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from ${tableName} t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid = #{projectId,jdbcType=VARCHAR}))
            <if test="puids != null and puids.size()>0">
                and t.puid in
                <foreach collection="puids" index="index" item="item"  open="(" separator="," close=")">
                    #{puids[${index}]}
                </foreach>
            </if>
            <if test="revision!= null">
                and t.P_REVISION is not null
            </if>
            <if test="status != null">
               and t.P_EBOM_STATUS = #{status,jdbcType=INTEGER}
            </if>
            <if test="orderId != null">
               and t.P_ORDER_ID = #{orderId,jdbcType=DOUBLE}
            </if>
        </where>
    </select>

    <!--查询一条有变更记录数据-->
    <select id="HzEbomRecordDAOImpl_getEBomRecordByPuidAndRevision" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from ${tableName} t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid = #{projectId,jdbcType=VARCHAR}))
            and t.puid =#{puid}
            <if test="revision!= null and revision !=''">
                and t.P_REVISION =#{revision,jdbcType=VARCHAR}
            </if>
            <if test="status != null">
                and t.P_EBOM_STATUS = #{status,jdbcType=INTEGER}
            </if>
        </where>
    </select>


    <!--根据变更单id 查询变更数据-->
    <select id="HzEbomRecordDAOImpl_getEbomRecordsByOrderId" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from ${tableName} t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        select t2.puid from Hz_project_libs t2
        <where>
            t2.puid = #{projectId,jdbcType=VARCHAR}))
            <if test="orderId!= null">
                and t.P_ORDER_ID =#{orderId,jdbcType=VARCHAR}
            </if>
            <if test="status != null">
                and t.P_EBOM_STATUS = #{status,jdbcType=INTEGER}
            </if>
            <if test="revision == 1">
                and t.P_REVISION is not null
            </if>
            <if test="revision == 0">
                and t.P_REVISION is null
            </if>
        </where>
    </select>

    <!--获取EBOM 2Y层 对应的lineIndex的第一个数字最大值-->
    <select id="HzEbomRecordDAOImpl_getMaxLineIndexFirstNum" parameterType="java.lang.String" resultMap="BaseResultMap">
        select <include refid="BASE_BOM_COLUMN"/> from HZ_BOM_LINE_RECORD t WHERE t.P_LINE_INDEX =
        (
        SELECT t1.P_LINE_INDEX from(
        select t2.P_LINE_INDEX,max(TO_NUMBER((substr(P_LINE_INDEX,instr(P_LINE_INDEX,'.',0),instr(P_LINE_INDEX,'.',1)-1)))) m
        from HZ_BOM_LINE_RECORD t2
        where t2.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3
        where t3.p_cfg0_of_which_project_puid= #{projectId,jdbcType=VARCHAR}
        )
        and t2.P_BOM_LINE_IS_2Y=1
        GROUP BY t2.P_LIne_INDEX
        ORDER BY m desc
        )t1
        where rownum =1
        )
        and t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3
        where t3.p_cfg0_of_which_project_puid= #{projectId,jdbcType=VARCHAR}
        )
    </select>

    <!--查询orderNum的最大值信息-->
    <select id="HzEbomRecordDAOImpl_findMaxBomOrderNum" resultType="java.lang.String">
        SELECT * FROM (
        SELECT t1.P_SORT_NUM from HZ_BOM_LINE_RECORD t1
         where t1.P_BOM_DIGIFAX_ID =(
        select t2.puid from Hz_Bom_Main_Record t2
        where
        t2.p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR}
        )order by CAST(t1.P_SORT_NUM as FLOAT) DESC)WHERE rownum = 1
    </select>


    <!--找出大于当前查找编号的最小记录-->
    <select id="HzEbomRecordDAOImpl_findMinEBOMRecordWhichLineNoGreaterCurrentLineNo" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        SELECT m.* from (SELECT
        <include refid="BASE_BOM_COLUMN"/>
        FROM
        HZ_BOM_LINE_RECORD t
        WHERE
        t.P_BOM_DIGIFAX_ID =(
        select t3.puid from Hz_Bom_Main_Record t3
        where t3.p_cfg0_of_which_project_puid= #{projectId,jdbcType=VARCHAR}
        )
        <if test="is2Y!= null">
            and t.P_BOM_LINE_IS_2Y =#{is2Y,jdbcType=INTEGER}
        </if>
        <if test="parentId != null">
            and t.P_PARENT_UID = #{parentId,jdbcType=VARCHAR}
        </if>
        and  TO_NUMBER (
        (
        SUBSTR (
        t.P_LINE_INDEX,
        INSTR (t.P_LINE_INDEX, '.', - 1) + 1
        )
        )
        ) &gt;#{lineNo,jdbcType=INTEGER}
        ORDER BY
        TO_NUMBER (
        (
        SUBSTR (
        t.P_LINE_INDEX,
        INSTR (t.P_LINE_INDEX, '.', - 1) + 1
        )
        )
        )
        )m
        WHERE rownum =1
    </select>

    <!--找出小于当前查找编号的最大记录-->
    <select id="HzEbomRecordDAOImpl_findMaxEBOMRecordWhichLineNoLessCurrentNo" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        SELECT m.* from (SELECT
        <include refid="BASE_BOM_COLUMN"/>
        FROM
        HZ_BOM_LINE_RECORD t
        WHERE
        t.P_BOM_DIGIFAX_ID =(
        select t3.puid from Hz_Bom_Main_Record t3
        where t3.p_cfg0_of_which_project_puid= #{projectId,jdbcType=VARCHAR}
        )
        <if test="is2Y!= null">
            and t.P_BOM_LINE_IS_2Y =#{is2Y,jdbcType=INTEGER}
        </if>
        <if test="parentId != null">
            and t.P_PARENT_UID = #{parentId,jdbcType=VARCHAR}
        </if>
        and  TO_NUMBER (
        (
        SUBSTR (
        t.P_LINE_INDEX,
        INSTR (t.P_LINE_INDEX, '.', - 1) + 1
        )
        )
        ) &lt;TO_NUMBER (#{lineNo,jdbcType=INTEGER})
        ORDER BY
        TO_NUMBER (
        (
        SUBSTR (
        t.P_LINE_INDEX,
        INSTR (t.P_LINE_INDEX, '.', - 1) + 1
        )
        )
        )desc
        )m
        WHERE rownum =1
    </select>


    <!--根据eplId 查询相同零件号的BOM-->
    <select id="HzEbomRecordDAOImpl_findEBOMRecordsByEPLId" parameterType="java.util.HashMap" resultMap="BaseResultMap">
        select <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where  1=1
        <if test="projectId!= null and projectId != ''">
            and t.p_bom_digifax_id=(
            select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
            #{projectId,jdbcType=VARCHAR})
            )
        </if>
        <if test="eplId != null">
            and t.P_EPL_ID = #{eplId,jdbcType=DOUBLE}
        </if>
    </select>

    <!--查询当前父层的子一层记录-->
    <select id="HzEbomRecordDAOImpl_findNextLevelRecordByParentId" parameterType="java.util.Map" resultMap="BaseResultMap">
        select <include refid="BASE_BOM_COLUMN"/>,<include refid="EPL_COLUMN"/>
        from HZ_BOM_LINE_RECORD t
        left join HZ_EPL_RECORD t10 on t.P_EPL_ID = t10.ID
        where t.p_bom_digifax_id=(
        select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
        #{projectId,jdbcType=VARCHAR})
        )
        and t.P_PARENT_UID = #{parentId,jdbcType=VARCHAR}
        ORDER BY  CAST(t.P_SORT_NUM as FLOAT)
    </select>



    <select id="HzEbomRecordDAOImpl_findEbomChildrenByLineIndex" parameterType="sql.pojo.epl.HzEPLManageRecord" resultMap="BaseResultMap">
      select
        <include refid="BASE_BOM_COLUMN"/>
      from
        (select <include refid="BASE_BOM_COLUMN"/> from HZ_BOM_LINE_RECORD t where P_PARENT_UID = #{puid,jdbcType=VARCHAR}) t
      where
        TO_NUMBER ((SUBSTR (P_LINE_INDEX,INSTR (P_LINE_INDEX, '.', -1) + 1))) = TO_NUMBER (#{lineIndex,jdbcType=VARCHAR})
    </select>

    <select id="HzEbomRecordDAOImpl_findPreviousEbom" parameterType="sql.pojo.epl.HzEPLManageRecord" resultMap="BaseResultMap">
        select
        <include refid="BASE_BOM_COLUMN"/>
        from
        HZ_BOM_LINE_RECORD t
        where
        t.P_SORT_NUM = (
          select MAX(P_SORT_NUM) from  HZ_BOM_LINE_RECORD where P_BOM_DIGIFAX_ID = #{bomDigifaxId,jdbcType=VARCHAR} and CAST(P_SORT_NUM as FLOAT)&lt; CAST(#{sortNum,jdbcType=VARCHAR} as FLOAT)
        )
        and
        t.P_BOM_DIGIFAX_ID = #{bomDigifaxId,jdbcType=VARCHAR}
    </select>

    <select id="HzEbomRecordDAOImpl_findNextLineIndex" parameterType="sql.pojo.epl.HzEPLManageRecord" resultMap="BaseResultMap">
        select
        <include refid="BASE_BOM_COLUMN"/>
        from
        (
            SELECT
              <include refid="BASE_BOM_COLUMN"/>
            FROM
            HZ_BOM_LINE_RECORD T
            WHERE
              t.P_PARENT_UID = #{puid,jdbcType=VARCHAR}
            AND
                TO_NUMBER ((SUBSTR (P_LINE_INDEX,INSTR (P_LINE_INDEX, '.', -1) + 1)))&gt; TO_NUMBER (#{lineIndex,jdbcType=VARCHAR})
            ORDER BY
                TO_NUMBER ((SUBSTR (P_LINE_INDEX,INSTR (P_LINE_INDEX, '.', -1) + 1)))
        ) t
        where rownum =1
    </select>

    <select id="HzEbomRecordDAOImpl_findBaseEbomById" resultMap="BaseResultMap" parameterType="java.util.HashMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>
        from
        HZ_BOM_LINE_RECORD t
        where
          t.p_bom_digifax_id=(select puid from Hz_Bom_Main_Record  where p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR})
        and
          t.P_EPL_ID = (select ID from HZ_EPL_RECORD where PART_ID = #{lineId,jdbcType=VARCHAR} and PROJECT_ID =#{projectId,jdbcType=VARCHAR})
    </select>

    <select id="HzEbomRecordDAOImpl_findNextSortNum" parameterType="sql.pojo.epl.HzEPLManageRecord" resultMap="BaseResultMap">
        SELECT <include refid="BASE_BOM_COLUMN"/>
        from
        HZ_BOM_LINE_RECORD t
        where
        t.P_BOM_DIGIFAX_ID = #{bomDigifaxId,jdbcType=VARCHAR}
        and
        t.P_SORT_NUM = (select MIN(CAST (P_SORT_NUM AS FLOAT)) from HZ_BOM_LINE_RECORD where P_BOM_DIGIFAX_ID = #{bomDigifaxId,jdbcType=VARCHAR} and CAST(P_SORT_NUM as FLOAT) &gt; CAST(#{sortNum,jdbcType=VARCHAR} as FLOAT))
    </select>

    <update id="HzEbomRecordDAOImpl_updateEPLList" parameterType="java.util.List">
      <foreach collection="list" index="index" item="item" open="begin" separator=";" close=";end;">
        update
          HZ_BOM_LINE_RECORD
         <set>
             <if test="item.isHas!=null">
                 P_BOM_LINE_IS_HAS = #{item.isHas,jdbcType=INTEGER},
             </if>
             <if test="item.sortNum!=null">
                 P_SORT_NUM = #{item.sortNum,jdbcType=INTEGER},
             </if>
             <if test="item.lineIndex!=null">
                 P_LINE_INDEX = #{item.lineIndex,jdbcType=INTEGER}
             </if>
         </set>
        where
          PUID  =#{item.puid,jdbcType=VARCHAR}
      </foreach>
    </update>

    <update id="HzEbomRecordDAOImpl_updateByDto" parameterType="com.connor.hozon.bom.resources.domain.dto.request.UpdateHzEbomReqDTO">
        update
          HZ_BOM_LINE_RECORD
        set
          P_UPC = #{pUpc,jdbcType=VARCHAR},
          P_FNA_INFO = #{fna,jdbcType=VARCHAR},
          P_FNA_DESC = #{pFnaDesc,jdbcType=VARCHAR},
          P_NUMBER = #{number,jdbcType=VARCHAR},
          P_COLOR_PART = #{colorPart,jdbcType=INTEGER}
        where
          P_BOM_DIGIFAX_ID = (select puid from Hz_Bom_Main_Record  where p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR})
        and
          P_EPL_ID = (select P_EPL_ID from HZ_BOM_LINE_RECORD where PUID = #{puid,jdbcType=VARCHAR})
    </update>

    <select id="HzEbomRecordDAOImpl_findEbom2Y" parameterType="java.util.List" resultMap="BaseResultMap">
        select
          <include refid="BASE_BOM_COLUMN"/>
        from(
            SELECT
              <include refid="BASE_BOM_COLUMN"/>
            from
              HZ_BOM_LINE_RECORD t
            where
              P_BOM_LINE_IS_2Y  = 1
            and
              P_BOM_DIGIFAX_ID = (select puid from Hz_Bom_Main_Record where p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR})
            <if test="flag=='previous'">
                and
                  TO_NUMBER ((SUBSTR (t.P_LINE_INDEX,INSTR (t.P_LINE_INDEX, '.', - 1) + 1)))&lt;TO_NUMBER(#{lineNo,jdbcType=VARCHAR})
                order by
                  TO_NUMBER ((SUBSTR (t.P_LINE_INDEX,INSTR (t.P_LINE_INDEX, '.', - 1) + 1)))desc
            </if>
            <if test="flag=='next'">
                and
                  TO_NUMBER ((SUBSTR (t.P_LINE_INDEX,INSTR (t.P_LINE_INDEX, '.', - 1) + 1)))&gt;TO_NUMBER(#{lineNo,jdbcType=VARCHAR})
                order by
                  TO_NUMBER ((SUBSTR (t.P_LINE_INDEX,INSTR (t.P_LINE_INDEX, '.', - 1) + 1))) asc
            </if>
        )t
        where rownum = 1
    </select>

    <select id="HzEbomRecordDAOImpl_findALLBOM" parameterType="java.lang.String" resultMap="BaseResultMap">
        select  PUID, P_PARENT_UID from EBOM_TEST t  where  t.P_BOM_DIGIFAX_ID =
        (select puid from Hz_Bom_Main_Record
         where p_cfg0_of_which_project_puid=#{projectId,jdbcType=VARCHAR})
          order by CAST(t.P_SORT_NUM as FLOAT)
    </select>
</mapper>