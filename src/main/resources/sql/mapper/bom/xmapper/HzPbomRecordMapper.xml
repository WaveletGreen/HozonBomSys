<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HzPbomRecord">
  <resultMap id="BaseResultMap" type="sql.pojo.bom.HzPbomRecord">
    <id column="P_PUID" jdbcType="VARCHAR" property="puid" />
    <result column="P_RESOURCE" jdbcType="VARCHAR" property="resource" />
    <result column="P_TYPE" jdbcType="INTEGER" property="type" />
    <result column="P_BUY_UNIT" jdbcType="INTEGER" property="buyUnit" />
    <result column="P_WORK_SHOP1" jdbcType="VARCHAR" property="workShop1" />
    <result column="P_WORK_SHOP2" jdbcType="VARCHAR" property="workShop2" />
    <result column="P_PRODUCT_LINE" jdbcType="VARCHAR" property="productLine" />
    <result column="P_MOULD_TYPE" jdbcType="VARCHAR" property="mouldType" />
    <result column="P_OUTER_PART" jdbcType="VARCHAR" property="outerPart" />
    <result column="P_COLOR_PART" jdbcType="INTEGER" property="colorPart" />
    <result column="P_STATION" jdbcType="VARCHAR" property="station" />
    <result column="P_CREATE_TIME" jdbcType="DATE" property="createTime" />
    <result column="P_UPDATE_TIME" jdbcType="DATE" property="updateTime" />
    <result column="P_CREATE_NAME" jdbcType="VARCHAR" property="createName" />
    <result column="P_UPDATE_NAME" jdbcType="VARCHAR" property="updateName" />
    <result column="P_PBOM_STATUS" jdbcType="INTEGER" property="status" />
    <result column="P_E_BOM_PUID" jdbcType="VARCHAR" property="eBomPuid" />
  </resultMap>

  <resultMap extends="BaseResultMap"  id="HzPbomLineRecord" type="sql.pojo.bom.HzPbomLineRecord">
    <id column="PUID" jdbcType="VARCHAR" property="pPuid" />
    <result column="P_LINE_INDEX" jdbcType="VARCHAR" property="lineIndex" />
    <result column="P_BOM_LINE_IS_HAS" jdbcType="INTEGER" property="isHas" />
    <result column="P_BOM_LINE_ID" jdbcType="VARCHAR" property="lineId" />
    <result column="P_BOM_LINE_IS_2Y" jdbcType="INTEGER" property="is2Y" />
    <result column="P_BOM_OF_WHICH_DEPT" jdbcType="VARCHAR" property="pBomOfWhichDept" />
    <result column="P_PARENT_UID" jdbcType="VARCHAR" property="parentUid"/>
    <result column="P_BOM_DIGIFAX_ID" jdbcType="VARCHAR" property="bomDigifaxId"/>
    <result column="P_BOM_LINE_PUID" jdbcType="VARCHAR" property="linePuid"/>
    <result column="P_BOM_LINE_IS_PART" jdbcType="INTEGER" property="isPart"/>
    <result column="P_BOM_ORDER_NUM" jdbcType="INTEGER" property="orderNum"/>
    <result column="P_BOM_LINE_IS_DEPT" jdbcType="INTEGER" property="isDept"/>
    <result column="P_BOM_LINE_PART_NAME" jdbcType="VARCHAR" property="pBomLinePartName"/>
    <result column="P_BOM_LINE_PART_CLASS" jdbcType="VARCHAR" property="pBomLinePartClass"/>
    <result column="P_BOM_LINE_BLOCK" jdbcType="BLOB" property="bomLineBlock"/>
  </resultMap>

  <sql id="Pbom_List">
    P_LINE_INDEX,P_BOM_LINE_IS_HAS,P_BOM_LINE_ID,P_BOM_LINE_IS_2Y,P_BOM_OF_WHICH_DEPT
  </sql>


  <sql id="Base_Column_List">
    P_PUID, P_STATION, P_RESOURCE, P_TYPE, P_BUY_UNIT, P_WORK_SHOP1, P_WORK_SHOP2, P_PRODUCT_LINE,
    P_MOULD_TYPE, P_OUTER_PART, P_COLOR_PART, P_E_BOM_PUID,P_PBOM_STATUS,P_CREATE_TIME,P_UPDATE_TIME
    P_CREATE_NAME,P_UPDATE_NAME,P_PBOM_STATUS
  </sql>



  <!--联表查询 EBOM PBOM信息-->
  <select id="HzPbomRecordDAOImpl_getPbomRecord" resultMap="HzPbomLineRecord" parameterType="java.util.HashMap">

    select t.*,t5.* from HZ_BOM_LINE_RECORD t
    LEFT OUTER JOIN HZ_BOM_STATE t6 on t.puid = t6.P_BOM_ID
    LEFT OUTER JOIN HZ_PBOM_RECORD t5 ON  t.puid = T5.p_E_BOM_PUID
    where t.p_bom_digifax_id=(
    select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
    select t2.puid from Hz_project_libs t2
    <where>
      t2.puid=#{projectId,jdbcType=VARCHAR}))
      <if test="lineId != null and  lineId!='' " >
        and t.P_BOM_LINE_ID = #{lineId,jdbcType=VARCHAR}
      </if>
      <if test="pPuid != null and  pPuid!='' " >
        and t.PUID = #{pPuid,jdbcType=VARCHAR}
      </if>
      and (t6.P_BOM_STATE is null or t6.P_BOM_STATE  <![CDATA[!= ]]>2)
      and (t5.P_PBOM_STATUS IS NULL OR t5.P_PBOM_STATUS=1)
    </where>
  </select>


  <!--联表查询PBOM 总数-->
  <select id="HzPbomRecordDAOImpl_getTotalCount" resultType="java.lang.Integer" parameterType="java.util.HashMap">

    select count(*) from HZ_BOM_LINE_RECORD t
    LEFT OUTER JOIN HZ_BOM_STATE t6 on t.puid = t6.P_BOM_ID
    LEFT OUTER JOIN HZ_PBOM_RECORD t5 ON  t.puid = T5.p_E_BOM_PUID
    where t.p_bom_digifax_id=(
    select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
    select t2.puid from Hz_project_libs t2
    <where>
      t2.puid=#{projectId,jdbcType=VARCHAR}))
      <if test="lineId != null and  lineId!='' " >
        and t.P_BOM_LINE_ID = #{lineId,jdbcType=VARCHAR}
      </if>
      and (t6.P_BOM_STATE is null or t6.P_BOM_STATE  <![CDATA[!= ]]>2)
      and (t5.P_PBOM_STATUS IS NULL OR t5.P_PBOM_STATUS=1)
    </where>
  </select>

  <!--查询PBOM子节点信息-->
  <select id="HzPbomRecordDAOImpl_getHzPbomById" resultMap="HzPbomLineRecord" parameterType="java.util.HashMap">

    select t.* from HZ_BOM_LINE_RECORD t
    where t.p_bom_digifax_id=(
    select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
    select t2.puid from Hz_project_libs t2
    <where>
        t2.puid = #{projectId,jdbcType=VARCHAR}))
      <if test="parentUid != null and  parentUid!='' " >
        and t.P_PARENT_UID = #{parentUid,jdbcType=VARCHAR}
      </if>
    </where>
  </select>






  <!--模糊搜索的分组号 零件号 暂时没有 模糊匹配后期需要加-->
  <select id="HzPbomRecordDAOImpl_searchPbomLineDetail" parameterType="sql.pojo.bom.HzPbomLineRecord" resultMap="HzPbomLineRecord">
    select
    t1.P_PUID,<include refid="Pbom_List" />,t2.*
    from HZ_BOM_LINE_RECORD t1 LEFT OUTER JOIN HZ_PBOM_RECORD t2
    on t1.P_PUID = t2.P_E_BOM_PUID
  <where>
    1=1
    <if test="pBomOfWhichDept != null and  pBomOfWhichDept!='' " >
      and t1.P_BOM_OF_WHICH_DEPT = #{pBomOfWhichDept,jdbcType=VARCHAR}
    </if>
    <if test="lineID != null and  lineID!=''">
      and t1.P_BOM_LINE_ID = #{lineID,jdbcType=VARCHAR}
    </if>
    <if test="isHas != null">
    and t1.P_BOM_LINE_IS_HAS = #{isHas,jdbcType=INTEGER}
    </if>
    <if test="lineIndex != null and  lineIndex!=''">
      and length(t1.P_LINE_INDEX) = #{lineIndex,jdbcType=VARCHAR}
    </if>
  </where>
  </select>



  <!--获取一条 EBOM&PBOM信息-->
  <select id="HzPbomRecordDAOImpl_getPbomById" resultMap="HzPbomLineRecord" parameterType="java.util.HashMap">

    select t.*,t6.* from HZ_BOM_LINE_RECORD t LEFT OUTER JOIN HZ_PBOM_RECORD t6 ON  t.puid = T6.p_E_BOM_PUID
    where t.p_bom_digifax_id=(
    select t3.puid from Hz_Bom_Main_Record t3 where t3.p_cfg0_of_which_project_puid=(
    select t2.puid from Hz_project_libs t2
    <where>
      t2.puid=#{projectId,jdbcType=VARCHAR}))
      <if test="lineId != null and  lineId!='' " >
        and t.P_BOM_LINE_ID = #{lineId,jdbcType=VARCHAR}
      </if>
      <if test="pPuid != null and  pPuid!='' " >
        and t.PUID = #{pPuid,jdbcType=VARCHAR}
      </if>
    </where>
  </select>


  <!--获取一条 PBOM记录-->
  <select id="HzPbomRecordDAOImpl_getHzPbomByEbomPuid" resultMap="BaseResultMap" parameterType="java.lang.String">

    SELECT * FROM HZ_PBOM_RECORD WHERE P_E_BOM_PUID = #{eBomPuid,jdbcType=VARCHAR} AND P_PBOM_STATUS=1

  </select>

  <!--插入-->
  <insert id="HzPbomRecordDAOImpl_insert" parameterType="sql.pojo.bom.HzPbomRecord">
    insert into HZ_PBOM_RECORD
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="puid != null">
        P_PUID,
      </if>
      <if test="station != null">
        P_STATION,
      </if>
      <if test="resource != null">
        P_RESOURCE,
      </if>
      <if test="type != null">
        P_TYPE,
      </if>
      <if test="buyUnit != null">
        P_BUY_UNIT,
      </if>
      <if test="workShop1 != null">
        P_WORK_SHOP1,
      </if>
      <if test="workShop2 != null">
        P_WORK_SHOP2,
      </if>
      <if test="productLine != null">
        P_PRODUCT_LINE,
      </if>
      <if test="mouldType != null">
        P_MOULD_TYPE,
      </if>
      <if test="outerPart != null">
        P_OUTER_PART,
      </if>
      <if test="colorPart != null">
        P_COLOR_PART,
      </if>
      <if test="eBomPuid != null">
        P_E_BOM_PUID,
      </if>
        P_CREATE_TIME,
        P_UPDATE_TIME,
      <if test="createName != null">
        P_CREATE_NAME,
      </if>
      <if test="updateName != null">
        P_UPDATE_NAME,
      </if>
        P_PBOM_STATUS
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="puid != null">
        #{puid,jdbcType=VARCHAR},
      </if>
      <if test="station != null">
        #{station,jdbcType=VARCHAR},
      </if>
      <if test="resource != null">
        #{resource,jdbcType=VARCHAR},
      </if>
      <if test="type != null">
        #{type,jdbcType=INTEGER},
      </if>
      <if test="buyUnit != null">
        #{buyUnit,jdbcType=INTEGER},
      </if>
      <if test="workShop1 != null">
        #{workShop1,jdbcType=VARCHAR},
      </if>
      <if test="workShop2 != null">
        #{workShop2,jdbcType=VARCHAR},
      </if>
      <if test="productLine != null">
        #{productLine,jdbcType=VARCHAR},
      </if>
      <if test="mouldType != null">
        #{mouldType,jdbcType=VARCHAR},
      </if>
      <if test="outerPart != null">
        #{outerPart,jdbcType=VARCHAR},
      </if>
      <if test="colorPart != null">
        #{colorPart,jdbcType=INTEGER},
      </if>
      <if test="eBomPuid != null">
        #{eBomPuid,jdbcType=VARCHAR},
      </if>
      sysdate,
      sysdate,
      <if test="createName != null">
          #{createName,jdbcType=VARCHAR},
      </if>
      <if test="updateName != null">
          #{updateName,jdbcType=VARCHAR},
      </if>
      1
    </trim>
  </insert>

  <!--更新-->
  <update id="HzPbomRecordDAOImpl_update" parameterType="sql.pojo.bom.HzPbomRecord">
    update HZ_PBOM_RECORD
    <set>
      <if test="station != null">
        P_STATION = #{station,jdbcType=VARCHAR},
      </if>
      <if test="resource != null">
        P_RESOURCE = #{resource,jdbcType=VARCHAR},
      </if>
      <if test="type != null">
        P_TYPE = #{type,jdbcType=INTEGER},
      </if>
      <if test="buyUnit != null">
        P_BUY_UNIT = #{buyUnit,jdbcType=INTEGER},
      </if>
      <if test="workShop1 != null">
        P_WORK_SHOP1 = #{workShop1,jdbcType=VARCHAR},
      </if>
      <if test="workShop2 != null">
        P_WORK_SHOP2 = #{workShop2,jdbcType=VARCHAR},
      </if>
      <if test="productLine != null">
        P_PRODUCT_LINE = #{productLine,jdbcType=VARCHAR},
      </if>
      <if test="mouldType != null">
        P_MOULD_TYPE = #{mouldType,jdbcType=VARCHAR},
      </if>
      <if test="outerPart != null">
        P_OUTER_PART = #{outerPart,jdbcType=VARCHAR},
      </if>
      <if test="colorPart != null">
        P_COLOR_PART = #{colorPart,jdbcType=INTEGER},
      </if>
       P_UPDATE_TIME =sysdate,
      <if test="createName != null">
          P_CREATE_NAME = #{createName,jdbcType=VARCHAR},
      </if>
      <if test="updateName != null">
          P_UPDATE_NAME = #{updateName,jdbcType=VARCHAR},
      </if>
    </set>
    where P_E_BOM_PUID = #{eBomPuid,jdbcType=VARCHAR}
  </update>


<!--删除一条记录-->
  <update id="HzPbomRecordDAOImpl_deleteByForeignId" parameterType="java.lang.String">
    update HZ_PBOM_RECORD
    set P_PBOM_STATUS = 0
    where P_E_BOM_PUID = #{eBomPuid,jdbcType=VARCHAR}
 </update>
</mapper>