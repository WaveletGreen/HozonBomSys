<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:include="include/includebase">
    <script th:src="@{user.js}"></script>
    <title>合众BOM管理系统</title>
</head>
<body>
<link rel="shortcut icon" href="http://www.weather.com.cn/favicon.ico" type="image/x-icon"/>
<link th:href="@{css/sb-admin.css}" rel="stylesheet"/>
<div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top nav_custom" role="navigation">
        <div class="navbar-header" id="navbar_header">
            <a class="navbar-brand" href="main"><img th:src="@{/img/logo.png}"><span>BOM管理系统</span></a>
        </div>
        <!-- Top Menu Items -->
        <ul class="nav navbar-right top-nav">
            <li>
                <a href="" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-user"></i>
                    <font>当前工作项目:</font>
                    <!--<mark class="caret">：</mark>-->
                    <font id="currentProjectHead"></font>

                </a>
                <ul class="dropdown-menu" id="projectList" style="max-height: 300px;overflow-y:scroll;"></ul>
            </li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-user"></i> <font
                        th:text="${#authentication.name}"></font> <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li class="divider"></li>
                    <li>
                        <a href="javascript:void(0)" onclick="updatePassword()"> <i class="fa fa-fw fa-gear"></i> 修改密码
                        </a>
                    </li>


                    <li class="divider"></li>
                    <li>
                        <a href="/hozon/login"><i class="fa fa-fw fa-power-off"></i>退 出</a>
                    </li>
                </ul>
            </li>
        </ul>
        <!-- Sidebar Menu Items - These collapse to the responsive navigation menu on small screens -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav side-nav" id="menu_tree">]
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </nav>
    <div id="page-wrapper" style="border-radius:5px 5px 0 0;">
        <input type="hidden" id="project" value="EP10项目"/>
        <div id="tabContainer"></div>
    </div>
</div>
</body>

<script th:inline="javascript">
    $(document).ready(
        (function () {
            var URL = document.URL.split("/");
            var contextPath = "/" + URL[3];
            // 页面加载完成以后开启websocket的连接
            var options = new Array();
            options.sockurl = contextPath + '/ricky-websocket';
            options.stompClienturl = '/ricky/topic/greetings';
            options.login = [[${#authentication.name}]];
            options.success = function (greeting) {
                var r = eval("(" + JSON.parse(greeting.body).content + ")")
                alert(r);
                // $("#greetings").append("<tr><td>" + JSON.parse(greeting.body).content + "</td></tr>");
            }
            $.fn.socketConnect(options);
            $("#tabContainer").tabs({
                data: [{
                    id: '99999999',
                    text: '首页',
                    url: "project",
                    closeable: false
                }],
                showIndex: 0,
                loadAll: false
            }),
                $("#tabContainer").tabs({
                    data: [{
                        id: '99999998',
                        text: '首页',
                        url: "project",
                        closeable: true
                    }],
                    showIndex: 1,
                    loadAll: false
                })
            //
            $.fn.bootstrapTree({url: contextPath + "/user/mainTree", treeId: 'menu_tree', tabId: "tabContainer"});
            $.fn.dictUtil("/dict/loadDict");
        })
    );
    $(document).ready(
        ($.ajax({
                url: "./project/loadAll",
                type: "GET",
                success: function (data) {
                    var auth = data.auth;
                    var _data = data.data;
                    var ok = true;
                    if (_data) {
                        $("#projectList").append(
                            "<li>" +
                            "<a href='javascript:void(0)' class='project' onclick='doChangeProject(\"" + "\")'>请选择项目</a>" +
                            "</li>" +
                            "<li class='divider'></li>"
                        );
                        for (var i in _data) {
                            // if (i == 0 && ok) {
                            //     $("#projectList", window.top.document).val(_data[i].puid);
                            //     $("#currentProject").text("当前工作项目:" + _data[i].pProjectName);
                            //     $("#currentProjectHead", window.top.document).text(_data[i].pProjectName);
                            //     ok = false;
                            //     if (!auth) {
                            //         break;
                            //     }
                            // }
                            // if (auth) {
                            //     $("#fastOption").append("<option value='" + _data[i].puid + "'>" + _data[i].pProjectName + "</option>");
                            // }

                            $("#projectList").append(
                                "<li>" +
                                "<a href='javascript:void(0)' class='project' onclick='doChangeProject(\"" + _data[i].puid + "\",\"" + _data[i].pProjectName + "\")'>" + _data[i].pProjectName + " </a>" +
                                "</li>" +
                                "<li class='divider'></li>"
                            );
                        }
                        console.log("加载项目成功");
                    }
                    if (auth) {
                        $("#fastOption").removeAttr("hidden");
                        $("#fastOption").addClass("form-control");
                        // $("#fastOption").bind("change", selectEvent);
                        $("#labHidden").removeAttr("hidden");
                    }
                },
                error: function (err) {
                    alert(err.status);
                }
            })
        ))

    function updatePassword() {
        window.Ewin.dialog({
            title: '修改密码',
            url: 'user/getUser',
            gridId: "gridId",
            width: 500,
            height: 500
        })
    };

    function doChangeProject(projectUid, projectName) {
        $("#project").val(projectUid);
        $("#currentProjectHead").text(projectName);
        myRefresh(projectUid);
    }

    function myRefresh(projectUid) {
        if ($.isFunction($(window.parent.document).contents().find(".tab-pane.fade.active.in iframe")[0].contentWindow.doRefresh)) {
            $(window.parent.document).contents().find(".tab-pane.fade.active.in iframe")[0].contentWindow.doRefresh(projectUid);
        }
    }

</script>
</html>